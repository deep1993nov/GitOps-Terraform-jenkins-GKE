pipeline {

    stages {

        stage ('Setting up WorkSpace'){
            steps{
                withCredentials([file(credentialsId: 'Dev-Cred', variable: 'cred-file')
                {
                    sh "cp \$cred-file cred-dev.json"
                }
            }

        }

        stage ('TF  INIT'){
            steps{
                dir('Terraform-manifests'){
            sh """
            cd {env.branch}
            terraform init
        """
                }
            }

        }

          stage ('TF  PLAN'){
              steps{
                    dir('Terraform-manifests'){
            sh """
            cd {env.branch}
            terraform plan -input=true -lock=true  -out=terraform.tfplan  -no-color
        """
                    }
              }

          }

         stage ('TF  APPLY'){
             steps{
                 script{
                    def apply = false
                    try {
                        input message: 'Can you please confirm the apply', ok: 'Ready to Apply the Config'
                        apply = true
                    } catch (err) {
                        apply = false
                         currentBuild.result = 'UNSTABLE'
                    }
                    if(apply){
                        dir('Terraform-manifests/'){

                            sh 'terraform apply terraform.tfplan'
                        }
                    }
                 }
             }

         }
    }
}
